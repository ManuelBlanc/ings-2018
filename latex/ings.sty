%% Definicion del paquete
\ProvidesPackage{ings}[2018/02/11]
\typeout{Package `ings', 1.0, <2018/02/11>}

%% Datos del documento
\ConfigurarDocumento{%
  universidad = UAM,
  grado       = 3º del Grado en Ingeniería Informática,
  asignatura  = Ingeniería del Software,
  curso       = 2017-18,
  %practica    = {1}{ ... }, % Se define en cada tex
  autores     = {M. Blanc, L.C. Jariego, P. Marcos, F. Martin, D. Nevado},
}

%% Declaracion de paquetes que usamos a continuacion
\RequirePackage{pgffor, tikz}
\usetikzlibrary{positioning} % LATEX and plain TEX

\NewDocumentCommand{\Plural}{mm}{{%
  \pgfkeysvalueof{#1} #2%
  \pgfmathsetmacro{\var}{\pgfkeysvalueof{#1}}%
  \pgfmathifthenelse{\var==1}{""}{"s"}\pgfmathresult}}

%%
%% Deck
%%
%% Un deck es una baraja de cartas.
%% Todas las cartas tienen los mismos atributos
%% en comun.
\pgfqkeys{/deck}{%
  % Define una clave de la tarjeta.
  card/add key/.style = { #1/.initial = \textcolor{red}{(Unset {#1})}, },
  card/add 2 keys/.style n args = {3}{%
    /deck/card/add key = {#1/#2},
    /deck/card/add key = {#1/#3},
    #1/.style 2 args = {#1/#2 = {##1}, #1/#3 = {##2}},
  },
  % Las cartas por defecto estan vacias.
  card/.code = {},
  % Una baraja consiste en ejecutar el codigo de la carta para cada carta.
  /deck/.style = { /deck/card/.list = {#1}, },
}


\newcounter{reqId}
\pgfqkeys{/ings/backlog}{
  /deck/card/add key/.list = {%
    identificador, valor cliente,
    iteracion, prioridad, comentarios
  },
  enunciado/.code = {%
    \pgfqkeys{/ings/backlog/enunciado}{%
      como/.initial = {COMO},
      quiero/.initial = {QUIERO},
      para/.initial = {PARA},
      #1,
    }%
    \pgfqkeys{/ings/backlog}{%
      enunciado/.initial = {%
        \textsc{como} \pgfkeysvalueof{/ings/backlog/enunciado/como}
        \textsc{quiero} \pgfkeysvalueof{/ings/backlog/enunciado/quiero}
        \textsc{para} \pgfkeysvalueof{/ings/backlog/enunciado/para}.
      }
    }
  },
  /deck/card/add 2 keys = {esfuerzo}{personas}{dias},
  format/.is choice,
  make id/.code = {R\refstepcounter{reqId}\arabic{reqId}\label{\pgfkeysvalueof{/ings/backlog/identificador}}},
  %
  % Nulo
  %
  format/none/.style = { /deck/card/.code = {}, },
  %
  % Lista
  %
  format/list/.style = {%
    /deck/card/.code = {%
      \pgfkeysalso{##1} % Visible desde toda la tabla
      \begin{tabular}{rp{11cm}}
        \textbf{Identificador}      & \pgfkeysalso{make id}                                     \\
        \textbf{Enunciado}          & \pgfkeysvalueof{/ings/backlog/enunciado}                  %%
          {\itshape\color{darkgray}   \pgfkeysvalueof{/ings/backlog/comentarios}}               \\
        \textbf{Valor cliente}      & \pgfkeysvalueof{/ings/backlog/valor cliente}              \\
        \textbf{Esfuerzo}           & \Plural{/ings/backlog/esfuerzo/personas}{persona} $\cdot$
                                      \Plural{/ings/backlog/esfuerzo/dias}{dia}                 \\
        \textbf{Iteracion}          & \pgfkeysvalueof{/ings/backlog/iteracion}                  \\
        \textbf{Prioridad}          & \pgfkeysvalueof{/ings/backlog/prioridad}                  \\
      \end{tabular}
      \vspace{0.33cm}\newline
      \rule{\textwidth}{1pt}\vspace{0.33cm}
      \newline
    }
  },
  %
  % TikZ [WIP]
  %
  format/tikz/.style = {%
    /deck/card/.code = {%
      \pgfkeysalso{##1}%
      \def\CardWidth{0.5\textwidth}%
      \begin{tikzpicture}[%[anchor = base, baseline] % =(X.base)
        ystep=-1cm,
        score/.style = {%
          draw=####1, fill=####1!10, thick, inner sep=0pt, outer sep=0pt, minimum height=7mm, minimum width=10mm,
        },
        every label/.style = { font = \scshape },
        block/.style = {%
          draw=black, anchor=south,text width=\CardWidth-18pt, inner sep = 9pt,
        }]

        \node (titulo)
          [anchor=north, block, align=center, fill=black!7]
          {\scshape Tarea \pgfkeysalso{make id}};

        \node (descripcion)
          [block, align=justify, below=0pt of titulo, text depth=14em]
          {\pgfkeysvalueof{/ings/backlog/enunciado} \newline
           {\itshape\color{darkgray}\pgfkeysvalueof{/ings/backlog/comentarios}}};

        \node (puntuacion) [above=30pt of descripcion.south] {};

        \node (valor)
          [score={yellow}, label={left:Valoración}, above left=0pt of puntuacion]
          {\pgfkeysvalueof{/ings/backlog/valor cliente}};

        \node (esfuerzo)
          [score={green}, label=left:Esfuerzo, below left=0pt of puntuacion]
          { \pgfkeysvalueof{/ings/backlog/esfuerzo/personas}
          / \pgfkeysvalueof{/ings/backlog/esfuerzo/dias}};

        \node (iteracion)
          [score={blue}, label=right:Iteración,, above right=0pt of puntuacion]
          {\pgfkeysvalueof{/ings/backlog/iteracion}};

        \node (prioridad)
          [score={red}, label=right:Prioridad,, below right=0pt of puntuacion]
          {\pgfkeysvalueof{/ings/backlog/prioridad}};

      \end{tikzpicture}\hskip-0pt%
    }
  },
  %
  % Tabla
  %
  format/table/.style = {%
    /deck/.add code = {%
      \tabular{|r|p{9.2cm}|l|l|l|l|}
        \hline
        Id. & Enunciado y comentarios & \multicolumn{4}{c|}{Valoraciones}  \\ \cline{3-6}
            &                         & Val & Esf & Ite & Pri              \\
        \hline
    }{%
      &&&&&\\\hline\endtabular
    },
    /deck/card/.code = {%
      % Cada celda forma un grupo aislado, y no tenemos ninguna manera de definir
      % claves para toda la fila sin usar globales (que prefiero evitar).
      % Lo que hacemos es re-ejecutar las claves en cada celda.
        \pgfkeysalso{##1}\pgfkeysalso{make id}
      & \pgfkeysalso{##1}\pgfkeysvalueof{/ings/backlog/enunciado}
        { \color{darkgray} \itshape \pgfkeysvalueof{/ings/backlog/comentarios} }
      & \pgfkeysalso{##1}\pgfkeysvalueof{/ings/backlog/valor cliente}
      & \pgfkeysalso{##1}\pgfkeysvalueof{/ings/backlog/esfuerzo/personas}
                 $\cdot$ \pgfkeysvalueof{/ings/backlog/esfuerzo/dias}
      & \pgfkeysalso{##1}\pgfkeysvalueof{/ings/backlog/iteracion}
      & \pgfkeysalso{##1}\pgfkeysvalueof{/ings/backlog/prioridad} \\%
    },
  }
}

%% \ProductBacklog. Recibe un unico argumento, un conjunto de
%% claves de pgfkeys que tendra varias veces el comando `add element`
\NewDocumentCommand{\ProductBacklog}{O{}m}{%
  \begingroup
  \pgfqkeys{/ings/backlog}{%
    format=list,
    #1, % Extra opts.
    /deck = {#2},
  }
  \endgroup
}

\newcommand{\Como}[1]{\textsc{Como} #1 \\}
\newcommand{\Quiero}[1]{\textsc{quiero} #1 \\}
\newcommand{\Para}[1]{\textsc{para} #1}
